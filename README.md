## Aruba switches config backup

The steps here can backup pretty much any switch config but since I had to work with Aruba switches, the exact steps are presented for it. But if you look to backup config of switches, network device or any other device which allows for picking the config from it through `scp` or any other command, this setup is going to work for you. 

We use `restic-api`, a web based backup tool that uses `restic` binary to do the backup. The tool has `command` support where you can execute a command, store the output of it to a file & then backup the file. `restic-api` provides a nice UI so that you do not have to worry about remember the `restic` commands. 

## 1. Install Restic API & restic binary 

Download/clone [restic-api](https://github.com/pocha/restic-api) from github. Check `install` folder for the installation steps. You need to have `restic` backup tool installed on the machine. `restic-api` uses restic to do the backup. You can download the latest restic binary from [https://github.com/restic/restic/releases](https://github.com/restic/restic/releases) before setting up `restic-api`

Once restic & restic-api are installed, visit `localhost:5000` to see the Restic API web UI. 

![restic api image](https://github.com/pocha/restic-api/raw/master/img/restic-screenshot.png)

*The rest of the article assumes that you have ubuntu machine on which you are running the `restic-api` for your switches backup*. If you are on a non ubuntu/linux machine, the command mentioned below to copy the switch config, will change. Rest will stay the same. 


## 2. Switch configuration changes

We need to ensure that machine running `restic-api` can `scp` the config from the switches to itself & then back it up. Below are the steps to ensure the same. 

Make sure scp is enabled on the switche. For Aruba switch, ssh into the device, run `config` command & then execute 

```
ip ssh filetransfer
```


Enable public key authentication so that password is not required for the scp

```
aaa authentication ssh enable public-key
```

Add public key of the machine running `restic-api`

```
ip ssh public-key manager 'ssh-rsa xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx' username manager 
```
Aruba switch only takes rsa public key. The default key generation might not be rsa. Generate rsa key with `ssh-keygen -t rsa ...` command on the machine `restic-api` is running. The part `ssh-rsa ....` is basically content of file `~/.ssh/id_rsa.pub`, which gets generated by `ssh-keygen` command. 

**Important** - To check if it all worked well, run `scp -O <switch user>@<switch ip>:/cfg/running-config /dev/stdout` on the machine where `restic-api` is running. You should see a dump of config without a password prompt. If it does not happen, something is still wrong & automated backup will NOT work. 

## 3. Scheduling backup with Restic API 

- Add a backup location, maybe, a directory on the backup machine, where backup of the configs will be stored. 
- Under `Schedule Backup`, choose `Command`. Specify command as the same that we tested before - `scp -O <switch-user>@<switch-ip>:/cfg/running-config /dev/stdout`. In `Filename`, specify a unique name to identify the backup file. 
- Once backup is scheduled, click on 'Backup Now' button next to the scheduled backup to check if backup works. 
- Once a backup is taken, go to `Restore` section, choose the appropriate backup location & restore directory option, click on Restore. It should list at least one backup snapshot. You can restore the backup in `/tmp` location & it should create `/tmp/<filename>` which you can compare with the config of the switch. 
